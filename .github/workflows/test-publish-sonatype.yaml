name: publish to sonatype

permissions:
  # This is required for requesting the OIDC token
  id-token: write

on:
  workflow_dispatch:
    inputs:
      target-branch:
        type: choice
        options:
          - main

jobs:
  promote-from-stage-to-prod:
    runs-on: ${{ vars.BUILD_CONTAINER_DISTRO_VERSION }}
    steps: 
        - name: Checkout
          uses: actions/checkout@v4
          with:
            # Fetch the whole history to prevent unrelated history errors
            fetch-depth: "0"
            ref: ${{ inputs.target-branch }}

        - name: Setup Java
          uses: actions/setup-java@v4
          with:
            distribution: "semeru" # See 'Supported distributions' for available options
            java-version: 21
            gpg-private-key: ${{ secrets.GPG_SECRET }}
            gpg-passphrase: GPG_PASS

        - name: build
          env:
            GPG_PASS: ${{ secrets.GPG_PASS }}
          run: |
            mvn clean source:jar javadoc:jar install gpg:sign -DskipTests

        - name: generate hashes in target folder
          run: |
            TARGET_DIR="target"
            
            # Recursively find the desired files and generate the hashes
            find "$TARGET_DIR" \
              \( -name '*.jar' -o -name '*.jar.asc' -o -name '*.pom' -o -name '*.pom.asc' \) -type f \
            | while read -r file; do
                # Generate MD5 hash (store just the hash in <file>.md5)
                md5sum "$file" | awk '{print $1}' > "${file}.md5"
                
                # Generate SHA1 hash (store just the hash in <file>.sha1)
                sha1sum "$file" | awk '{print $1}' > "${file}.sha1"
                
                echo "Generated MD5 and SHA1 for: $file"
            done

        - name: stage artifacts
          run: |
            ls -la target/
            mkdir -p {staging,github,sonatype}
            mkdir -p staging/net/zimaspace/1.0/java-test-bench/
            cp target/*.jar staging/net/zimaspace/1.0/java-test-bench
            cp target/*.pom staging/net/zimaspace/1.0/java-test-bench
            cp target/*.asc staging/net/zimaspace/1.0/java-test-bench
            cp target/*.pom staging/net/zimaspace/1.0/java-test-bench
            cp target/*.md5 staging/net/zimaspace/1.0/java-test-bench
            cp target/*.sha1 staging/net/zimaspace/1.0/java-test-bench
            ls staging

        - name: get-build-name-number
          id: get-build-name-number
          run: |
              echo build-name-number="$(echo 'clients-java-push-to-dev_aerospike-test-bench-jdk21/${{ github.run_id }}')" >> $GITHUB_OUTPUT

        - uses: ./.github/actions/publish-to-sonatype
          id: publish-to-sonatype
          with:
            build-name-number: ${{ steps.get-build-name-number.outputs.build-name-number }}
            publish-user: ${{ secrets.CICD_USERNAME }}
            publish-password: ${{ secrets.CICD_PASSWORD }}
            validation-max-number-checks: ${{ vars.VALIDATION_MAX_NUMBER_CHECKS }}
            sonatype-domain-name: ${{ vars.SONATYPE_DOMAIN_NAME }}
        
